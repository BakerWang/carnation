<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title></title>
<link href="$!webPath/resources/style/system/manage/$!{config.websiteCss}/template.css"  rel="stylesheet" type="text/css"/>
<link href="$!webPath/resources/style/common/css/overlay.css" type="text/css" rel="stylesheet" />
<script src="$!webPath/resources/js/jquery-1.6.2.js"></script>
<script src="$!webPath/resources/js/jquery-ui-1.8.21.js"></script>
<script src="$!webPath/resources/js/jquery.shop.common.js"></script>
<script src="$!webPath/resources/js/jquery.validate.min.js"></script>
<script src="$!webPath/resources/js/jquery.poshytip.min.js"></script>
<script>
function complaint_audit(){
 if(confirm("确定要审核通过该订单吗?")){	
   $("#theForm").attr("action","$!webPath/admin/self_complaint_audit.htm");
   $("#theForm").submit();
 }
}
function complaint_close(){
  $("div[id^=complaint_op_]").hide();
  $("#complaint_close").show();
  $('#complaint_handle').show();
}
function complaint_talk(){
   var talk_content=$("#talkContent").val();
  $.post("$!webPath/admin/self_complaint_talk.htm",{"talkContent":talk_content,"id":"$!obj.id"},function(data){
	  $("#talk_content_detail").empty();	
      $.each(data, function(index,item){
	      $("#talk_content_detail").append("<li class='"+item.role+"'>"+item.content+"</li>");
	  })
  },"json");
   $("#talkContent").val("");
   alert("发布对话成功！");
}
function complaint_talk_reload(){
  $.post("$!webPath/admin/self_complaint_talk.htm",{"talkContent":"","id":"$!obj.id"},function(data){
	  $("#talk_content_detail").empty();	
      $.each(data, function(index,item){
	      $("#talk_content_detail").append("<li class='"+item.role+"'>"+item.content+"</li>");
	  })
  },"json");
}
function complaint_handle_close(){
  if(confirm("处理后不可更改，确定处理该投诉吗？")){	
	if($("#handle_content").val()!=""){
	  $("#theForm").attr("action","$!webPath/admin/self_complaint_handle_close.htm");
	  $("#theForm").submit();
	}else{
      alert("请输入处理意见！");
	}
  }
}
$(function() {
	$(".comp_box_proces li").removeClass("this");
	$("#complaint_$!{obj.status}").addClass("this");
	setInterval(complaint_talk_reload, 5000);
});
</script>
</head>
<body>
<div class="cont">
  <h1 class="seth">投诉管理</h1>
  <div class="nav_list">
  <ul>
   
   <li><a href="$!webPath/admin/self_complaint_list.htm?status=talk" #if($!status=="talk")class="this"#end><b>对话中</b></a></li>
   <li><a href="$!webPath/admin/self_complaint_list.htm?status=close" #if($!status=="close")class="this"#end><b>已关闭</b></a></li>
   <li><a href="$!webPath/admin/self_complaintsubject_list.htm?self=1"><b>投诉主题</b></a></li>
   <li><a href="$!webPath/admin/self_complaintsubject_add.htm?self=1"><b>新增投诉主题</b></a></li>
   <li><a href="$!webPath/admin/self_complaint_set.htm?self=1"><b>投诉设置</b></a></li>
   <li><a href="javascript:void(0);" class="this"><b>投诉详情</b></a></li>
  
   </ul>
   </div>
  <form action="" method="post" id="theForm">
    <input name="id" type="hidden" id="id" value="$!obj.id" />
  <div class="compback">
    <div class="backcomp">
      <div class="reputh">投诉进度</div>
      <div class="comp_box_proces">
        <ul>
          <li class="this" id="complaint_0">新投诉</li>
          <li id="complaint_2">对话中</li>
          <li id="complaint_4"> 已完成</li>
        </ul>
      </div>
    </div>
    <div class="backcomp">
      <div class="reputh">订单详情</div>
      <div class="backcomp_box">
        <dl class="backcomp_d">
          <dt>订单信息</dt>
          <dd>
            <ul class="backcomp_u">
              #if($!obj.orderStatus==0)
              #set($status="已取消")
              #end
              #if($!obj.orderStatus==10)
              #set($status="待付款")
              #end
              #if($!obj.orderStatus==20)
              #set($status="已付款")
              #end
              #if($!obj.orderStatus==30)
              #set($status="已发货")        
              #end                
              #if($!obj.orderStatus==40)
              #set($status="已收货")
              #end
              #if($!obj.orderStatus==50)
              #set($status="已完成,已评价")                                              
              #end
              #if($!obj.orderStatus==60)
              #set($status="已结束")                                              
              #end
              <li>订单状态：<strong>$!status</strong></li>
              <li>订单号：<b class="blue">$!obj.orderId</b> </li>
              <li>下单时间：<strong>$!CommUtil.formatLongDate($!obj.orderTime)</strong></li>
              <li>订单总额:<strong>¥$!{obj.orderTotal}</strong></li>
            </ul>
          </dd>
        </dl>
        <dl class="backcomp_d">
          <dt>商家信息</dt>
          <dd>
            <ul class="backcomp_u">
            <!--<li>商家店铺：<b><a href="$!webPath/store_$!{obj.to_user.store.id}.htm" target="_blank">云尚平台</a></b> </li>-->
              <li>商家店铺：<b><a href="$!webPath/store_$!{obj.to_user.store.id}.htm" target="_blank">云尚平台</a></b> </li>
            </ul>
          </dd>
        </dl>
        <dl class="backcomp_d">
          <dt>买家信息</dt>
          <dd>
            <ul class="backcomp_u">
              <li>买家名称：<strong>$!{obj.fromName}</strong> </li>
            </ul>
          </dd>
        </dl>
      </div>
    </div>
    <div class="backcomp">
      <div class="reputh">投诉详情</div>
      <div class="backcomp_box">
        <dl class="backcomp_d">
          <dt>投诉信息</dt>
          <!--class="backcomp_hover"去掉背景消失-->
          <dd class="backcomp_hover">
            <ul class="backcomp_u">
              #if($!obj.status==0)
              #set($status="新投诉")
              #end
              #if($!obj.status==1)
              #set($status="待申诉")
              #end
              #if($!obj.status==2)
              #set($status="对话中")
              #end
              #if($!obj.status==3)
              #set($status="待仲裁")
              #end
              #if($!obj.status==4)
              #set($status="已完成")
              #end
              <li>投诉状态：<strong>$status</strong></li>
              #if($!obj.type=="buyer")
              #set($type="买家投诉")
              #else
              #set($type="商家投诉")
              #end
              <li>投诉类别<strong>$!type</strong></li>
              <li>投诉人:<strong>$!obj.fromName</strong></li>
              <li>投诉主题：<strong>$!obj.title</strong></li>
              <li>投诉证据:<b class="blue"><a href="$!webPath/admin/complaint_img.htm?id=$!obj.id&type=buyer" target="_blank"> 查看图片</a></b> </li>
              <li>投诉时间:<strong>$!CommUtil.formatLongDate($!obj.addTime)</strong></li>
            </ul>
          </dd>
        </dl>
        <dl class="backcomp_d">
          <dt>投诉商品</dt>
          <dd>
            <table width="95%" border="0" cellspacing="0" cellpadding="0" class="backcomp_table">
              <tr class="backcomp_table_th">
                <td width="50%">商品名称</td>
                <td width="20%">商品信息</td>
                <td width="15%" align="center">数量</td>
                <td width="15%" align="center">价格</td>
              </tr>
                          #foreach($map in $!orderFormTools.queryGoodsInfo("$!obj.goodsInfo"))
                            #set($goods_id = "$!{map.get('goods_id')}")	
                            #if($!obj.goodsId==$goods_id)
                              #set($goods_name = "$!{map.get('goods_name')}")
           				      #set($goods_count = "$!{map.get('goods_count')}")
              			      #set($goods_price = "$!{map.get('goods_price')}")
                              #set($goods_gsp_val = "$!{map.get('goods_gsp_val')}")
                              #set($goods_mainphoto_path = "$!{map.get('goods_mainphoto_path')}")
                              #set($img="$!{goods_mainphoto_path}")
                            #end   
              <tr>
              <tr class="backcom_table_boder">
                <td class="backcomp_img_deta"><strong>
                  <a href="$!shopPath/goods_$!{goods_id}.htm" target="_blank"><img width="80px" height="80px" src="$!img" /></a>
                </strong><b><a href="$!shopPath/goods_$!{goods_id}.htm" target="_blank">$!{goods_name}</a></b></td>
                <td class="backcomp_img_deta">$!{goods_gsp_val}</td>
                
                <td align="center">$!{goods_count}</td>
                <td align="center">¥$!{goods_price}</td>
              </tr>
              <tr>
                <td colspan="4" class="hui2">问题描述:$!obj.goodsContent</td>
              </tr>
             #end
            </table>
          </dd>
        </dl>
        <dl class="backcomp_d">
          <dt>投诉内容</dt>
          <dd>
            <div class="backcomp_cont">$!obj.fromUserContent</div>
          </dd>
        </dl>
      </div>
    </div>
    #if($!obj.status>1)
    <!-- <div class="backcomp">
      <div class="reputh">申诉详情</div>
      <div class="backcomp_box">
        <dl class="backcomp_d">
          <dt>申诉信息</dt>
          <dd>
            <ul class="backcomp_u">
              <li>申诉人：<strong>$!obj.toName</strong></li>
              <li>申诉证据：<b class="blue"><a href="$!webPath/admin/complaint_img.htm?id=$!obj.id&type=seller" target="_blank">查看图片</a></b> </li>
              <li>申诉时间：<strong>$!CommUtil.formatLongDate($!obj.appealTime)</strong></li>
            </ul>
          </dd>
        </dl>
        <dl class="backcomp_d">
          <dt>申诉内容</dt>
          <dd>
            <div class="backcomp_cont">$!obj.toUserContent</div>
          </dd>
        </dl>  
      </div>
    </div> -->
    <div class="backcomp">
      <div class="reputh">对话详情</div>
      <div class="backcomp_box">
        <dl class="backcomp_d">
          <dt>对话记录</dt>
          <dd>
            <div class="backcomp_cont_text">
              <div class="backcomp_cont_scol">
                <ul id="talk_content_detail">
                 #foreach($talk in $CommUtil.str2list("$!obj.talkContent"))
                    #if($!CommUtil.indexOf("$!talk","管理员")==0)
                       #set($class="admin")
                    #end
                    #if($!CommUtil.indexOf("$!talk","申诉")==0)
                       #set($class="from_user")
                    #end
                    #if($!CommUtil.indexOf("$!talk","投诉")==0)
                       #set($class="to_user")
                    #end
                    <li class="$!class">$!talk</li>
                  #end
                 </ul>
              </div>
            </div>
          </dd>
        </dl>
        #if($!obj.status>1 && $!obj.status<4)
        <dl class="backcomp_d">
          <dt>仲裁对话</dt>
          <dd>
            <div class="backcomp_cont_text">
              <textarea name="talkContent" cols="" rows="" id="talkContent"></textarea>
            </div>
            <span class="submit">
        <input name="" type="button" value="加入对话" style="cursor:pointer;" onclick="complaint_talk();"/>
        </span><span class="submit">
        <input type="button" value="刷新对话" style="cursor:pointer;" onclick="complaint_talk_reload();"/>
        </span>
          </dd>
        </dl>
        #end
      </div>
    </div>
   #end
   #if($!obj.status==4)
   <div class="backcomp">
      <div class="reputh">仲裁详情</div>
      <div class="backcomp_box">
        <dl class="backcomp_d">
          <dt>仲裁信息</dt>
          <dd>
            <ul class="backcomp_u">
              <li>仲裁管理员：<strong>$!obj.handName</strong></li>
              <li>仲裁时间：<strong>$!CommUtil.formatLongDate($!obj.handleTime)</strong></li>
            </ul>
          </dd>
        </dl>
        <dl class="backcomp_d">
          <dt>仲裁内容</dt>
          <dd>
            <div class="backcomp_cont">$!obj.handleContent</div>
          </dd>
        </dl>  
      </div>
    </div>
   #end
   #if($!obj.status>=0 && $!obj.status<4)
   <div class="backcomp" id="complaint_handle" style="display:none;">
      <div class="reputh">处理意见</div>
      <div class="backcomp_box">
        <dl class="backcomp_d">
          <dd>
            <div class="backcomp_cont_text">
              <textarea name="handle_content" cols="" rows="" id="handle_content"></textarea>
            </div>
          </dd>
        </dl>
      </div>
    </div>
    #end
    #if($!obj.status!=1 && $!obj.status<4)
    <div class="backcomp">
      <div class="reputh">投诉处理</div>
      #if($!obj.status==0)
      <div class="comback_btn" id="complaint_op_0"><span class="submit">
        <input name="" type="button" value="审核" style="cursor:pointer;" onclick="complaint_audit();"/>
        </span><span class="submit">
        <input name="" type="button" value="关闭投诉" style="cursor:pointer;" onclick="complaint_close();"/>
        </span>
      </div>
      #end
       #if($!obj.status>1 && $!obj.status<4)
      <div class="comback_btn" id="complaint_op_0"><span class="submit">
        <input name="" type="button" value="关闭投诉" style="cursor:pointer;" onclick="complaint_close();"/>
        </span>
      </div>
      #end
        <div class="comback_btn" id="complaint_close" style="display:none;"><span class="submit">
        <input name="" type="button" value="提交" style="cursor:pointer;" onclick="complaint_handle_close();"/>
        </span><span class="submit">
        <input name="" type="button" value="取消" style="cursor:pointer;" onclick="$('#complaint_op_0').show();$('#complaint_close').hide();$('#complaint_handle').hide();"/>
        </span></div>
    </div>
    #end
  </div>
  </form>
</div>
</body>
</html>
