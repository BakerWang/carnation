<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>0元购</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <meta name="format-detection" content="telephone=no">
    	<meta name="format-detection" content="email=no">
    	<link rel="stylesheet" type="text/css" href="$!webPath/resources/css/common.css"/>
    	<link rel="stylesheet" type="text/css" href="$!webPath/resources/css/zeroGo.css"/>
		<script>
			var screenWidth=window.innerWidth||document.documentElement.clientWidth;
			document.documentElement.style.fontSize = parseInt(screenWidth /7.5 ) + "px";
			/* if(screenWidth>=750){
				document.documentElement.style.fontSize = "100px";
			} */
	        var isAndroid = window.navigator.appVersion.match(/android/gi);
	        var isIPhone = window.navigator.appVersion.match(/iphone/gi);
	        var devicePixelRatio = window.devicePixelRatio;
	        if (isIPhone) {
	            if (devicePixelRatio >= 3) {                
	                dpr = 3;
	            } else if (devicePixelRatio >= 2){
	                dpr = 2;
	            } else {
	                dpr = 1;
	            }
	        } else {
	            dpr = 1;
	        }
	    	document.documentElement.setAttribute('data-dpr', dpr);  
		</script>
	   	<script src="$!webPath/resources/js/base64.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			function is_weixin(){
				var ua = navigator.userAgent.toLowerCase();
				if(ua.match(/MicroMessenger/i)=="micromessenger") {
					return true;
			 	} else {
					return false;
				}
			}
			function getUrlPar(name) {
				   var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)","i");
				   var r = window.location.search.substr(1).match(reg);
				   if (r!=null) return (r[2]); return null;
			}
			function wxlogin(){	
				//alert("isflag = "+getUrlPar('isflag'));
				if(is_weixin()&&getUrlPar('isflag')==null){
					var url=Base64.encode(location.href);
					var invitationCode=getUrlPar('invitationCode');
					if(parseInt(invitationCode)==NaN) return;
					var domain;
					if(location.href.indexOf("ysysgo.com")>-1){
						domain="http://mobile.ysysgo.com";
					}else if(location.href.indexOf("ysysgo.cn")>-1){
						domain="http://mobile.ysysgo.cn";
					}
					//alert(domain+"/user/loginUrl.htm?url='"+url+"'&invitationCode="+invitationCode+"&login=0");
					location.href=domain+"/user/loginUrl.htm?url='"+url+"'&invitationCode="+invitationCode+"&login=0";
				}
			}
			wxlogin();			
		</script>
		
	</head>
	<body>
	<style>
	html,body{width:100%;}
	</style>	
		<div class="page">
			<div class="top"></div>			
			<div class="goodsList">
				<ul id="goodsContainer">
									
				</ul>
			</div>
			<p class="loadingMore">正在加载更多商品</p>
		</div>
		<div class="floatbtn">
			<a href="javascript:;" class="share">分享</a>
			<a href="javascript:;" class="top">顶部</a>
		</div>
		
		<script type="text/javascript" src="$!webPath/resources/js/jquery.min.js" ></script>
		<script type="text/javascript" src="$!webPath/resources/js/common.js" ></script>
		<script type="text/javascript" src="$!webPath/resources/js/tools.js" ></script>
		<!-- 微信分享 -->
		<script src="$!webPath/resources/js/jweixin-1.0.0.js" type="text/javascript"></script>
		<script>
		    wx.config({
		        debug: false,
		        appId: '${appId}',
		        timestamp: '${timestamp}',
		        nonceStr: '${nonceStr}',
		        signature: '${signature}',
		        jsApiList: [
		         'checkJsApi',
		          'onMenuShareTimeline',
		          'onMenuShareAppMessage',
		        ]
		    });
    	</script>
		<script>
		    wx.ready(function () {
				    wx.onMenuShareTimeline(shareObj);
				        wx.onMenuShareAppMessage(shareObj);
		    });
		    wx.error(function (res) {
		    	//alert('xx' + res);
		    });
		</script>
    	
	   	<script type="text/javascript">
		    var isWeixin=is_weixin();
	        var isApp=fn.getQueryPar("ysysgo_app");
	        var isAndroid=fn.mobileType.isAndroid;
	        var isIos=fn.mobileType.isIos;
	        var shareObj={
	        	title:'HI翻全场，等你来抢！',
	        	desc:'特大福利来袭！全场0元！独乐乐不如众乐乐，赶紧告诉TA！',
	        	imgUrl:'$!webPath/resources/img/zero_share_icon.png',
	        	link:'$!webPath/zeroList.htm',
	        	success:function(){
	        		
	        	},
	        	cancel:function(){
	        		
	        	}
	        }
	   	
	        function img_preLoad(obj){	        	
	        	var imgObj=obj,count=imgObj.length;	        	
	        	if(count!=0){
	        		imgObj.each(function(){						
							var img=document.createElement("img");
							var dataSrc=$(this).attr("data-src");							
							if(img.complete){						
								$(this).attr("src",dataSrc);
							}else{						
								img.onload=function(){							
									$(this).attr("src",dataSrc);							
								}
							}
							img.src=dataSrc;		
	        		});        	
	        	}	        	
	        }
	        
	        
	        $(".floatbtn .top").on("touchend",function(){
	        	document.documentElement.scrollTop=0;
	        	document.body.scrollTop=0;
	        });
	        
	        $(".share").on('touchstart',function(){
	        	if(isApp=='true'){
	        		if(isAndroid){
	        			java.requestCommonShare(shareObj.title,shareObj.desc,shareObj.imgUrl,shareObj.link);
	        		}else if(isIos){
	        			requestCommonShare(shareObj);
	        		}
	        	}
	        });
	        
	        function is_weixin(){
				var ua = navigator.userAgent.toLowerCase();
				if(ua.match(/MicroMessenger/i)=="micromessenger") {
					return true;
			 	} else {
					return false;
				}
			}	        
	       
	        function buy(id){
	        	if(isApp=='true'){
	        		if(isAndroid){
	        			java.requestZeroDetails(id);
	        		}else if(isIos){
	        			requestZeroDetails(id);
	        		}
	        	}else if(isWeixin){
	        		location.href="$!webPath/goods_"+id+".htm";
	        	}else{
	        		alert('请在云尚app或微信内抢购');
	        	}        	
	        }
	        
	        $(document).ready(function(){
	        	if(isApp!='true'){
	        		$(".share").hide();
	        	}
	        	var obj=[];
	        	$.ajax({
	                type: "post",
	                url: "$!webPath/zero/goodsList.htm",
	                data: {},
	                dataType: "json",
	                anysc:false,
	                success: function (data) {
	                    if (data!=undefined && data.length > 0) {
	                    	console.log(data);
	                        obj=data;
	                        var pageSize=10;
	                        var pageNum=Math.ceil(obj.length/pageSize);
	                        var nowPage=1;
	                        appendData();
	            	        function appendData(){
	            	        	var html="";
	            	        	var max=Math.min(obj.length,nowPage*pageSize);
	            	        	if(pageNum==nowPage){
	            	        		$(".loadingMore").html('我是有底线的');
	            	        	}
	            	        	for(var i=(nowPage-1)*pageSize;i<max;i++){
	            	        		
	            	        		var total=parseInt(obj[i].goodsSalenum) + parseInt(obj[i].goodsInventory);
	            	        		var per=Math.floor(parseInt(obj[i].goodsSalenum)/total*100);
	            	        		
	            	        		html+="					<li>";
	            	        		if(per!=100){
	            	        			html+="	<a href='javascript:;' onclick=\"buy('"+obj[i].goodsId+"')\"><img src='$!webPath/resources/img/loading@2x.png' data-src='"+obj[i].goodsMainPhotoPath+"'  /></a>"
	            	        		}else{
	            	        			html+="	<img src='$!webPath/resources/img/loading@2x.png' data-src='"+obj[i].goodsMainPhotoPath+"'  />";
	            	        		}	            					
	            					html+="	<p class='tit'>"+obj[i].goodsName+"</p>";
	            					html+="	<div class='price'><span class='fn-rmb'>&yen;</span><span class='zero'>0</span><span class='orign'><span class='fn-rmb'>&yen;</span><span class='ori_price'>"+obj[i].oldGoodsPrice+"</span></span></div>"
	            					html+="	<div class='goodsNum fn-clear'>";	            					
	            					if(per==100){
	            						html+="		<div class='left' style='background-color:#eeeeee;border:solid 1px #eeeeee'>";
	            						html+="<div class=\"numDiv\">";
										html+="<span class=\"num\"></span>";
										html+="</div>";	            						
		            					html+="			<p style=\"color:9f9f9f\">100%</p>";		            					
	            					}else if(per>=80){
	            						html+="		<div class='left'>";
	            						html+="<div class=\"numDiv\" style=\"width:80%\">";
										html+="<span class=\"num\"></span>";
										html+="</div>";	
		            					html+="			<p>即将售罄</p>";
		            					html+="			<span class='hot'></span>";
	            					}else{
	            						html+="		<div class='left'>";
	            						html+="<div class=\"numDiv\" style=\"width:"+per+"%\">";
										html+="<span class=\"num\"></span>";
										html+="</div>";	
		            					html+="			<p>"+per+"%</p>";		            					
	            					} 
	            					html+="		</div>";
	            					html+="		<div class='right'>已抢"+obj[i].goodsSalenum+"件</div>";
	            					html+="	</div>";
	            					html+="<span class='line'></span>";
	            					if(obj[i].goodsInventory==0){
	            						html+="	<a href='javascript:;' class='btn gray'>立即抢购</a>";
	            					}else{
	            						html+="	<a href='javascript:;' class='btn' onclick=\"buy('"+obj[i].goodsId+"')\">立即抢购</a>";
	            					}
	            					if(per==100){
	            						html+="<span class=\"soldout\"></span>";
	            					}
	            					
	            					html+="</li>";
	            	        	}
	            	        	nowPage++;
	            				$("#goodsContainer").append(html);
	            				setTimeout(function(){
	            					img_preLoad($(".goodsList ul li img"));
	            				},100);	            				
	            	        }
	            	        
	            	   		var processor = {  
	            				    timeoutId: null, 		 
	            				    performProcessing: function(){	            				    	
	            				    	var totalheight = parseFloat($(window).height()) + parseFloat($(window).scrollTop());
	            			            if ($(document).height()-5 <= totalheight) {	            			                
            			                    	appendData();	            			              
	            			            }
	            				    },  		 
	            				    process: function(){
	            				        clearTimeout(this.timeoutId);  
	            				        this.timeoutId  = setTimeout(function(){ 
	            				            processor.performProcessing();  
	            				        }, 100);  
	            				    }  
            				}; 
	            		   	
            		        window.onscroll=processor.process;
	                        
	                    }
	                },
	                error: function (XMLHttpRequest, textStatus, errorThrown) {
	                    alert("服务器繁忙，请稍后..");
	                    return;
	                }
	            });
	        });
	    </script>
	</body>
</html>
