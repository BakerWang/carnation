<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sinco.carnation.user.mapper.RebateRecordMapper" >
  <resultMap id="BaseResultMap" type="com.sinco.carnation.user.model.RebateRecord" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="operator_id" property="operatorId" jdbcType="BIGINT" />
    <result column="seller_user_id" property="sellerUserId" jdbcType="BIGINT" />
    <result column="user_id" property="userId" jdbcType="BIGINT" />
    <result column="order_id" property="orderId" jdbcType="BIGINT" />
    <result column="rebate_code" property="rebateCode" jdbcType="VARCHAR" />
    <result column="order_user_id" property="orderUserId" jdbcType="BIGINT" />
    <result column="code_amount" property="codeAmount" jdbcType="DECIMAL" />
    <result column="rebate_status" property="rebateStatus" jdbcType="VARCHAR" />
    <result column="rebate_type" property="rebateType" jdbcType="VARCHAR" />
    <result column="rebate_amount" property="rebateAmount" jdbcType="DECIMAL" />
    <result column="send_time" property="sendTime" jdbcType="TIMESTAMP" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="user_type" property="userType" jdbcType="VARCHAR" />
  </resultMap>
  	<resultMap id="BOResultMap" type="com.sinco.carnation.user.bo.RebateRecordBO"
		extends="BaseResultMap">
		<result column="total_amout" property="totalRebateAmout"
			jdbcType="DECIMAL" />
		<result column="years" property="years" jdbcType="INTEGER" />
		<result column="months" property="months" jdbcType="INTEGER" />
		<result column="local_group_name" property="localGroupName"
			jdbcType="VARCHAR" />
		<result column="user_nickname" property="userNickName"
			jdbcType="VARCHAR" />
		<result column="group_sn" property="groupSn" jdbcType="VARCHAR" />
		<result column="mobile" property="mobile" jdbcType="VARCHAR" />
		<result column="nickname" property="nickname" jdbcType="VARCHAR" />
		<result column="rebate_amount" property="rebateAmount"
			jdbcType="DECIMAL" />
		<result column="gg_name" property="ggName" jdbcType="VARCHAR" />
		<result column="storeId" property="storeId" jdbcType="INTEGER" />
		<result column="store_name" property="storeName" jdbcType="VARCHAR" />
		<result column="login_name" property="loginName" jdbcType="VARCHAR" />
		<result column="totalAmount" property="totalAmount" jdbcType="DECIMAL" />
		<result column="orderType" property="orderType" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="OperatorProfitListMap" type="com.sinco.carnation.user.bo.RebateRecordBO"
		extends="BaseResultMap">
		<result column="store_name" property="storeName" jdbcType="VARCHAR" />
	</resultMap>
	<resultMap id="OperatorResultMap" type="com.sinco.carnation.user.bo.RebateRecordBO"
		extends="BaseResultMap">
		<association property="operator"
			javaType="com.sinco.carnation.user.model.Operator"
			resultMap="com.sinco.carnation.user.mapper.OperatorMapper.BaseResultMap"
			columnPrefix="o_"></association>
	</resultMap>
  <sql id="Example_Where_Clause" >
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List" >
    id, operator_id, seller_user_id, user_id, order_id, rebate_code, order_user_id, code_amount, 
    rebate_status, rebate_type, rebate_amount, send_time, create_time, user_type
  </sql>
  
  
	<select id="findrebateAmountByUidType" resultType="Bigdecimal">
		SELECT
		SUM(rebate_amount)
		FROM
		user_rebate_record
		WHERE
		rebate_status = 1
		AND user_id = #{uid}
		<if test="typeList != null">
			AND rebate_type IN
			<foreach collection="typeList" item="type" open="(" close=")"
				separator=",">
				#{type}
			</foreach>
		</if>
		<if test="startTime != null and startTime != ''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') <![CDATA[ >= ]]>
			DATE_FORMAT(#{startTime},'%Y-%m-%d')
		</if>
		<if test="endTime != null and endTime != ''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') <![CDATA[ <= ]]>
			DATE_FORMAT(#{endTime},'%Y-%m-%d')
		</if>
	</select>

	<select id="findAllByUidAndTime" resultMap="OperatorProfitListMap">
		SELECT * from user_rebate_record
		where rebate_status = 1 and user_id =
		#{uid}
		<if test="startTime != null and startTime != ''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') <![CDATA[ >= ]]>
			DATE_FORMAT(#{startTime},'%Y-%m-%d')
		</if>
		<if test="endTime != null and endTime != ''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') <![CDATA[ <= ]]>
			DATE_FORMAT(#{endTime},'%Y-%m-%d')
		</if>
	</select>

	<select id="selectRebateSumByArea" resultType="Bigdecimal">
		SELECT SUM(r.rebate_amount) FROM user_rebate_record r
		<if test="areaId != null and  areaId != ''">
			INNER JOIN shop_store s ON r.seller_user_id =
			s.create_user_id
			INNER JOIN dic_area a ON s.area_id = a.id
		</if>
		WHERE
		r.rebate_status = 1
		<choose>
			<when test="rebateType == 1">AND r.rebate_type BETWEEN 100 AND 200</when>
			<when test="rebateType == 2">AND r.rebate_type BETWEEN 200 AND 300</when>
		</choose>
		<if test="areaId != null and  areaId != ''">
			AND s.store_status = 15 AND s.is_o2o = 1
			AND (a.id =
			#{areaId} OR a.parent_id = #{areaId})
		</if>
	</select>

	<select id="selectOneRecordByCodeAndType" resultMap="OperatorProfitListMap">
		SELECT * from user_rebate_record
		WHERE 1=1
		AND rebate_type=#{rebateType}
		AND rebate_code=#{rebateCode}
	</select>
	
	<select id="selectOneRecordeByCode" resultMap="OperatorProfitListMap">
		SELECT * from user_rebate_record
		WHERE 1=1
		AND rebate_code=#{rebateCode}
	</select>
	

	<select id="queryByUser" resultMap="OperatorProfitListMap">
		<!-- select * from user_rebate_record rr, user_customer uc, sys_user_account 
			ua where rr.user_id=uc.uid AND rr.rebate_status = 1 AND rr.user_id != 0 and 
			uc.uid=ua.uid -->
		select * from user_rebate_record rr ,
		(SELECT uc.uid,uc.nickname,ua.login_name from user_customer uc,sys_user su,
		sys_user_account ua where uc.uid=ua.uid and su.id=ua.uid and
		su.user_type=1 group by uid ORDER BY uid asc)
		as uu where rr.user_id=uu.uid and
		rr.rebate_status = 1 AND rr.user_id != 0
		<if test="vo.userId != null and vo.userId != 0">
			and rr.user_id=#{vo.userId}
		</if>
		<if test="vo.nickname != null and vo.nickname != ''">
			and uu.nickname=#{vo.nickname}
		</if>
		<if test="vo.mobile != null and vo.mobile != ''">
			and uu.login_name=#{vo.mobile}
		</if>
		order by rr.send_time desc, rr.create_time desc
	</select>

	<select id="selectSumByTypeUid" resultType="Bigdecimal">
		SELECT
		SUM(rebate_amount)
		FROM
		user_rebate_record
		WHERE
		user_id = #{userId}
		<if test="typeList != null">
			AND rebate_type IN
			<foreach collection="typeList" item="type" open="(" close=")"
				separator=",">
				#{type}
			</foreach>
		</if>
		<choose>
			<when test="queryType == 0">
				AND rebate_status = 1
				AND rebate_code LIKE <![CDATA[ "%life%" ]]>
			</when>
			<otherwise>
				AND rebate_code NOT LIKE <![CDATA[ "%life%" ]]>
			</otherwise>
		</choose>
		<if test="startTime != null and startTime != ''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') <![CDATA[ >= ]]>
			DATE_FORMAT(#{startTime},'%Y-%m-%d')
		</if>
		<if test="endTime != null and endTime != ''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') <![CDATA[ <= ]]>
			DATE_FORMAT(#{endTime},'%Y-%m-%d')
		</if>
	</select>

	<select id="selectSumByTypeAndUserId" resultType="Bigdecimal">
		SELECT
		SUM(rebate_amount)
		FROM
		user_rebate_record
		WHERE
		rebate_status = 1
		AND user_id = #{userId}
		<if test="typeList != null">
			AND rebate_type IN
			<foreach collection="typeList" item="type" open="(" close=")"
				separator=",">
				#{type}
			</foreach>
		</if>
		<if test="startTime != null and startTime != ''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') <![CDATA[ >= ]]>
			DATE_FORMAT(#{startTime},'%Y-%m-%d')
		</if>
		<if test="endTime != null and endTime != ''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') <![CDATA[ <= ]]>
			DATE_FORMAT(#{endTime},'%Y-%m-%d')
		</if>
	</select>
	<select id="selectSumRechargeByUserId" resultType="Bigdecimal">
		SELECT
		SUM(r.rebate_amount)
		FROM user_rebate_record r
		INNER JOIN user_owns o ON r.seller_user_id =
		o.seller_user_id
		WHERE
		r.user_id = #{userId}
		AND r.rebate_status = 1
		<choose>
			<when test="isOwn == 1">AND o.own_operator_id = #{operatorId}</when>
			<when test="isOwn == 0">AND (o.own_operator_id != #{operatorId} OR
				ISNULL(o.own_operator_id))</when>
		</choose>
		AND r.rebate_type BETWEEN 200 AND 300
		<if test="startTime != null and startTime != ''">
			AND DATE_FORMAT(r.create_time,'%Y-%m-%d') <![CDATA[ >= ]]>
			DATE_FORMAT(#{startTime},'%Y-%m-%d')
		</if>
		<if test="endTime != null and endTime != ''">
			AND DATE_FORMAT(r.create_time,'%Y-%m-%d') <![CDATA[ <= ]]>
			DATE_FORMAT(#{endTime},'%Y-%m-%d')
		</if>
	</select>
	<select id="selectSumAreaByVO" resultType="Bigdecimal">
		SELECT SUM(r.rebate_amount) FROM user_rebate_record r
		INNER JOIN
		user_operator o ON r.user_id = o.user_id
		INNER JOIN shop_store buyShop
		ON buyShop.create_user_id = r.seller_user_id
		LEFT JOIN user_relation ur
		ON ur.user_id = r.order_user_id
		LEFT JOIN shop_store oShop ON
		oShop.create_user_id = ur.seller_user_id
		LEFT JOIN user_owns own ON
		own.seller_user_id = oShop.create_user_id
		WHERE r.user_id =
		#{vo.userId} AND r.rebate_status = 1 AND own.own_operator_id !=
		#{vo.operatorId}
		<if test="vo.typeList != null">
			AND r.rebate_type IN
			<foreach collection="vo.typeList" item="type" open="(" close=")"
				separator=",">
				#{type}
			</foreach>
		</if>
		<if test="vo.startTime != null and vo.startTime != ''">
			AND DATE_FORMAT(r.create_time,'%Y-%m-%d') <![CDATA[ >= ]]>
			DATE_FORMAT(#{vo.startTime},'%Y-%m-%d')
		</if>
		<if test="vo.endTime != null and vo.endTime != ''">
			AND DATE_FORMAT(r.create_time,'%Y-%m-%d') <![CDATA[ <= ]]>
			DATE_FORMAT(#{vo.endTime},'%Y-%m-%d')
		</if>
		<choose>
			<when test="vo.userLevel == 1">
				<choose>
					<when test="vo.type == 1">
						AND (SELECT count(0) FROM dic_area a WHERE a.id =
						buyShop.area_id AND a.parent_id = #{vo.operatorAreaId}) > 0
						AND
						(SELECT count(0) FROM dic_area a WHERE a.id = oShop.area_id AND
						a.parent_id = #{vo.operatorAreaId}) > 0
					</when>
					<when test="vo.type == 2">
						AND (SELECT count(0) FROM dic_area a WHERE a.id =
						buyShop.area_id AND a.parent_id = #{vo.operatorAreaId}) = 0
						AND
						(SELECT count(0) FROM dic_area a WHERE a.id = oShop.area_id AND
						a.parent_id = #{vo.operatorAreaId}) > 0
					</when>
					<when test="vo.type == 3">
						AND (SELECT count(0) FROM dic_area a WHERE a.id =
						buyShop.area_id AND a.parent_id = #{vo.operatorAreaId}) > 0
						AND
						(SELECT count(0) FROM dic_area a WHERE a.id = oShop.area_id AND
						a.parent_id = #{vo.operatorAreaId}) = 0
					</when>
				</choose>
			</when>
			<when test="vo.userLevel == 2">
				<choose>
					<when test="vo.type == 1">
						AND buyShop.area_id = #{vo.operatorAreaId} AND
						oShop.area_id = #{vo.operatorAreaId}
					</when>
					<when test="vo.type == 2">
						AND (ISNULL(buyShop.area_id) OR buyShop.area_id !=
						#{vo.operatorAreaId}) AND oShop.area_id = #{vo.operatorAreaId}
					</when>
					<when test="vo.type == 3">
						AND buyShop.area_id = #{vo.operatorAreaId} AND
						(ISNULL(oShop.area_id) OR oShop.area_id != #{vo.operatorAreaId})
					</when>
				</choose>
			</when>
			<when test="vo.userLevel == 3">AND 1=2</when>
		</choose>
	</select>
	<select id="selectSumOwnByVO" resultType="Bigdecimal">
		SELECT SUM(r.rebate_amount) FROM user_rebate_record r
		INNER JOIN
		user_owns o ON r.seller_user_id = o.seller_user_id
		INNER JOIN
		user_relation ur ON ur.user_id = r.order_user_id
		INNER JOIN user_owns
		o2 ON ur.seller_user_id = o2.seller_user_id
		WHERE r.user_id =
		#{vo.userId} AND r.rebate_status = 1
		<if test="vo.typeList != null">
			AND r.rebate_type IN
			<foreach collection="vo.typeList" item="type" open="(" close=")"
				separator=",">
				#{type}
			</foreach>
		</if>
		<if test="vo.startTime != null and vo.startTime != ''">
			AND DATE_FORMAT(r.create_time,'%Y-%m-%d') <![CDATA[ >= ]]>
			DATE_FORMAT(#{vo.startTime},'%Y-%m-%d')
		</if>
		<if test="vo.endTime != null and vo.endTime != ''">
			AND DATE_FORMAT(r.create_time,'%Y-%m-%d') <![CDATA[ <= ]]>
			DATE_FORMAT(#{vo.endTime},'%Y-%m-%d')
		</if>
		<choose>
			<when test="vo.type == 1">
				AND o.own_operator_id = #{vo.operatorId} AND
				o2.own_operator_id = #{vo.operatorId}
			</when>
			<when test="vo.type == 2">
				AND (o.own_operator_id != #{vo.operatorId} OR
				ISNULL(o.own_operator_id)) AND o2.own_operator_id = #{vo.operatorId}
			</when>
			<when test="vo.type == 3">
				AND o.own_operator_id = #{vo.operatorId} AND
				(o2.own_operator_id != #{vo.operatorId} OR
				ISNULL(o2.own_operator_id))
			</when>
		</choose>
	</select>

	<select id="queryOperatorProfitList" resultMap="OperatorProfitListMap">
		SELECT
		CASE WHEN r.seller_user_id != 0
		THEN
		(CASE WHEN s.store_name IS NULL
		THEN
		(CASE WHEN uo.operator_name IS NULL
		THEN
		(CASE WHEN sa.login_name IS NULL
		THEN '商户未设置名称'
		ELSE sa.login_name
		END)
		ELSE uo.operator_name
		END)
		ELSE s.store_name
		END)
		ELSE '云尚'
		END AS 'store_name',
		r.create_time, r.rebate_amount, r.rebate_type FROM user_rebate_record r
		LEFT JOIN user_seller us ON r.seller_user_id = us.uid
		LEFT JOIN shop_store s ON s.id = us.store_id
		LEFT JOIN sys_user_account sa ON (r.seller_user_id = sa.uid AND
		account_type = 2)
		LEFT JOIN user_operator uo ON r.seller_user_id = uo.user_id
		WHERE r.user_id = #{uid} AND r.rebate_status = 1
		<if test="group != null ">
		  AND s.is_o2o=#{group}
		</if>
		<if test="shop != null ">
		  AND s.is_shop=#{shop}
		</if>
		order by r.create_time desc
	</select>

	<select id="selectOperatorRebateCode" resultMap="OperatorResultMap">
		SELECT r.*, o.level o_level, o.operator_name o_operator_name,
		o.operator_code o_operator_code, o.operator_area_id
		o_operator_area_id, o.phone o_phone
		FROM user_rebate_record r
		INNER JOIN user_operator o ON r.user_id = o.user_id
		WHERE o.is_deleted = 0 AND r.rebate_status = 1 AND r.user_id != 0
		<if test="vo.operatorCode != null and  vo.operatorCode != ''">
			AND o.operator_code = #{vo.operatorCode}
		</if>
		<if test="vo.operatorName != null and  vo.operatorName != ''">
			AND o.operator_name LIKE CONCAT('%',#{vo.operatorName},'%')
		</if>
		<if test="vo.operatorMobile != null and  vo.operatorMobile != ''">
			AND o.phone = #{vo.operatorMobile}
		</if>
		ORDER BY r.send_time desc, r.create_time DESC
	</select>

	<select id="selectOperatorRebateRecordTotal" resultType="DECIMAL">
		SELECT
		SUM(r.rebate_amount)
		FROM
		user_rebate_record r
		WHERE
		r.user_id = #{operatorUserId}
		AND r.rebate_status = #{status}
	</select>
	<select id="selectOperatorRebateRecordList" resultMap="BOResultMap">
		SELECT
		s.id as storeId,
		CASE WHEN r.seller_user_id != 0
		THEN
		(CASE WHEN s.store_name IS NULL
		THEN
		(CASE WHEN uo.operator_name IS NULL
		THEN
		(CASE WHEN sa.login_name IS NULL
		THEN '商户未设置名称'
		ELSE sa.login_name
		END)
		ELSE uo.operator_name
		END)
		ELSE s.store_name
		END)
		ELSE '云尚'
		END AS 'store_name',
		r.create_time,
		r.rebate_amount,
		r.code_amount,
		r.rebate_type,
		us.user_name
		FROM
		user_rebate_record r
		LEFT JOIN user_seller us ON r.seller_user_id = us.uid
		LEFT JOIN shop_store s ON s.id = us.store_id
		LEFT JOIN sys_user_account sa ON (r.seller_user_id = sa.uid AND
		account_type = 2)
		LEFT JOIN user_operator uo ON r.seller_user_id = uo.user_id
		WHERE
		r.user_id = #{operatorUserId}
		AND r.rebate_status = #{status}
		<if test="vo.userType != null and vo.userType != ''">
			and r.user_type =#{vo.userType}
		</if>
		<if test="vo.storeName != null and vo.storeName != ''">
			and s.store_name like concat('%',#{vo.storeName},'%')
		</if>
		<if test="vo.type != null and vo.type != ''">
			and r.rebate_type=#{vo.type}
		</if>
		<if test="vo.beginTimeStr != null and vo.beginTimeStr != ''">
			AND DATE_FORMAT(r.create_time,'%Y-%m-%d') <![CDATA[ >=]]>
			DATE_FORMAT(#{vo.beginTimeStr},'%Y-%m-%d')
		</if>
		<if test="vo.endTimeStr != null and vo.endTimeStr != ''">
			AND DATE_FORMAT(r.create_time,'%Y-%m-%d') <![CDATA[ <= ]]>
			DATE_FORMAT(#{vo.endTimeStr},'%Y-%m-%d')
		</if>
		<if test="vo.loginName != null and vo.loginName != ''">
			AND us.user_name=#{vo.loginName}
		</if>
		<if test="vo.group != null">
			<!-- AND s.is_o2o=#{vo.group} -->
		</if>
		ORDER BY r.create_time DESC
	</select>
	<select id="queryShareDetails" resultMap="BOResultMap">
		SELECT
		CASE WHEN LENGTH(REBATE_CODE)>12 THEN '订单号' ELSE '消费码' END AS 'orderType',
		CASE WHEN g.gg_name IS NULL THEN '返润' ELSE g.gg_name END AS 'gg_name',
		o.local_group_name,
		c.mobile,
		c.nickname,
		o.user_nickname,
		r.rebate_amount,
		r.rebate_code,
		r.create_time,
		r.rebate_type
		FROM
		user_rebate_record r
		LEFT JOIN o2o_group_order o ON o.id = r.order_id
		LEFT JOIN user_customer c ON c.uid = r.order_user_id
		LEFT JOIN o2o_group_info gi ON gi.group_sn = r.rebate_code
		LEFT JOIN o2o_group_goods g ON g.id = gi.goods_id
		WHERE r.rebate_status = 1 AND r.user_id =#{uid}
		<if test="vo != null and vo.mobile != null and vo.mobile != ''">
			and c.mobile like concat('%',#{vo.mobile},'%')
		</if>
		<if test="vo != null and vo.beginTimeStr != null and vo.beginTimeStr != ''">
			and DATE_FORMAT(r.create_time,'%Y-%m-%d') <![CDATA[>=]]>
			DATE_FORMAT(#{vo.beginTimeStr},'%Y-%m-%d')
		</if>
		<if test="vo != null and vo.endTimeStr != null and vo.endTimeStr != ''">
			and DATE_FORMAT(r.create_time,'%Y-%m-%d') <![CDATA[<=]]>
			DATE_FORMAT(#{vo.endTimeStr},'%Y-%m-%d')
		</if>
		<if test="userType != null">
			and r.user_type=#{userType}
		</if>
		ORDER BY r.create_time DESC
	</select>

	<select id="queryShareListByVO" resultMap="BOResultMap">
		SELECT
		s.store_name,
		suser.login_name,
		g.gg_name,
		o.local_group_name,
		c.mobile,
		c.nickname,
		o.user_nickname,
		r.rebate_amount,
		r.rebate_code,
		r.create_time,
		r.rebate_type
		FROM
		user_rebate_record r
		LEFT JOIN o2o_group_order o ON o.id = r.order_id
		LEFT JOIN user_customer c ON c.uid = r.order_user_id
		LEFT JOIN o2o_group_info gi ON gi.group_sn = r.rebate_code
		LEFT JOIN o2o_group_goods g ON g.id = gi.goods_id
		LEFT JOIN user_seller us ON r.user_id = us.uid
		LEFT JOIN shop_store s ON s.id = us.store_id
		LEFT JOIN sys_user_account suser ON (suser.uid = r.user_id and
		suser.account_type=2)
		WHERE r.rebate_status = 1 and us.uid is not null AND r.user_id != 0
		<if test="vo.storeName != null and vo.storeName != ''">
			AND s.store_name like concat('%',#{vo.storeName},'%')
		</if>
		<if test="vo.loginName != null and vo.loginName != ''">
			AND suser.login_name like concat('%',#{vo.loginName},'%')
		</if>
		<if test="vo.beginTimeStr != null and vo.beginTimeStr != ''">
		<![CDATA[AND date(r.create_time) >=#{vo.beginTimeStr,jdbcType=TIMESTAMP}]]>
		</if>
		<if test="vo.endTimeStr != null and vo.endTimeStr != ''">
		<![CDATA[AND date(r.create_time) <= #{vo.endTimeStr,jdbcType=TIMESTAMP}]]>
		</if>
		<if test="vo.rebateType != null and vo.rebateType != ''">
			and r.rebate_type = #{vo.rebateType}
		</if>
		ORDER BY r.send_time desc, r.create_time DESC
	</select>

	<select id="queryRebateCount" resultMap="BOResultMap">
		SELECT YEAR(r.create_time) AS years,MONTH( r.create_time) AS months
		,SUM(r.rebate_amount) AS total_amout
		FROM user_rebate_record r WHERE DATE_FORMAT(r.create_time
		,'%y')=DATE_FORMAT(CURDATE(),'%y') and r.user_id=#{uid} AND
		r.rebate_status = 1
		<if test="userType != null">
			and r.user_type = #{userType}
		</if>
		GROUP BY YEAR(r.create_time) DESC,MONTH( r.create_time) DESC
	</select>

	<select id="queryrebatesum" resultMap="BOResultMap">
		SELECT SUM(r.rebate_amount) as total_amout FROM user_rebate_record r
		WHERE r.user_id=#{storeId} AND r.rebate_status = 1
		<if test="startTime != null">
			and r.create_time <![CDATA[ >= #{startTime}]]>
		</if>
		<if test="endTime != null">
			and r.create_time <![CDATA[ <= #{endTime}]]>
		</if>
		<if test="userType == 'o2o'">
			and (r.user_type = 'o2o' or r.user_type = 'seller') 
		</if>
		<if test="userType != null">
			and r.user_type = #{userType}
		</if>
	</select>
	
	<update id="updatePreRecordToAlready" parameterType="java.util.Map">
		update user_rebate_record
		set rebate_status=1,send_time=create_time,create_time = #{createTime}
		where 1=1
		and id = #{id}
	</update>
  
  <select id="selectByExample" parameterType="com.sinco.carnation.user.model.RebateRecordExample" resultMap="BOResultMap" >
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from user_rebate_record
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
    <if test="limit != null" >
      limit ${limit}
    </if>
  </select>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BOResultMap" >
    select 
    <include refid="Base_Column_List" />
    from user_rebate_record
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    delete from user_rebate_record
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <delete id="deleteByExample" parameterType="com.sinco.carnation.user.model.RebateRecordExample" >
    delete from user_rebate_record
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.sinco.carnation.user.model.RebateRecord" useGeneratedKeys="true" keyProperty="id" >
    insert into user_rebate_record (id, operator_id, seller_user_id, 
      user_id, order_id, rebate_code, 
      order_user_id, code_amount, rebate_status, 
      rebate_type, rebate_amount, send_time, 
      create_time, user_type)
    values (#{id,jdbcType=BIGINT}, #{operatorId,jdbcType=BIGINT}, #{sellerUserId,jdbcType=BIGINT}, 
      #{userId,jdbcType=BIGINT}, #{orderId,jdbcType=BIGINT}, #{rebateCode,jdbcType=VARCHAR}, 
      #{orderUserId,jdbcType=BIGINT}, #{codeAmount,jdbcType=DECIMAL}, #{rebateStatus,jdbcType=VARCHAR}, 
      #{rebateType,jdbcType=VARCHAR}, #{rebateAmount,jdbcType=DECIMAL}, #{sendTime,jdbcType=TIMESTAMP}, 
      #{createTime,jdbcType=TIMESTAMP}, #{userType,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.sinco.carnation.user.model.RebateRecord" useGeneratedKeys="true" keyProperty="id" >
    insert into user_rebate_record
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="operatorId != null" >
        operator_id,
      </if>
      <if test="sellerUserId != null" >
        seller_user_id,
      </if>
      <if test="userId != null" >
        user_id,
      </if>
      <if test="orderId != null" >
        order_id,
      </if>
      <if test="rebateCode != null" >
        rebate_code,
      </if>
      <if test="orderUserId != null" >
        order_user_id,
      </if>
      <if test="codeAmount != null" >
        code_amount,
      </if>
      <if test="rebateStatus != null" >
        rebate_status,
      </if>
      <if test="rebateType != null" >
        rebate_type,
      </if>
      <if test="rebateAmount != null" >
        rebate_amount,
      </if>
      <if test="sendTime != null" >
        send_time,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="userType != null" >
        user_type,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="operatorId != null" >
        #{operatorId,jdbcType=BIGINT},
      </if>
      <if test="sellerUserId != null" >
        #{sellerUserId,jdbcType=BIGINT},
      </if>
      <if test="userId != null" >
        #{userId,jdbcType=BIGINT},
      </if>
      <if test="orderId != null" >
        #{orderId,jdbcType=BIGINT},
      </if>
      <if test="rebateCode != null" >
        #{rebateCode,jdbcType=VARCHAR},
      </if>
      <if test="orderUserId != null" >
        #{orderUserId,jdbcType=BIGINT},
      </if>
      <if test="codeAmount != null" >
        #{codeAmount,jdbcType=DECIMAL},
      </if>
      <if test="rebateStatus != null" >
        #{rebateStatus,jdbcType=VARCHAR},
      </if>
      <if test="rebateType != null" >
        #{rebateType,jdbcType=VARCHAR},
      </if>
      <if test="rebateAmount != null" >
        #{rebateAmount,jdbcType=DECIMAL},
      </if>
      <if test="sendTime != null" >
        #{sendTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="userType != null" >
        #{userType,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.sinco.carnation.user.model.RebateRecordExample" resultType="java.lang.Integer" >
    select count(*) from user_rebate_record
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map" >
    update user_rebate_record
    <set >
      <if test="record.id != null" >
        id = #{record.id,jdbcType=BIGINT},
      </if>
      <if test="record.operatorId != null" >
        operator_id = #{record.operatorId,jdbcType=BIGINT},
      </if>
      <if test="record.sellerUserId != null" >
        seller_user_id = #{record.sellerUserId,jdbcType=BIGINT},
      </if>
      <if test="record.userId != null" >
        user_id = #{record.userId,jdbcType=BIGINT},
      </if>
      <if test="record.orderId != null" >
        order_id = #{record.orderId,jdbcType=BIGINT},
      </if>
      <if test="record.rebateCode != null" >
        rebate_code = #{record.rebateCode,jdbcType=VARCHAR},
      </if>
      <if test="record.orderUserId != null" >
        order_user_id = #{record.orderUserId,jdbcType=BIGINT},
      </if>
      <if test="record.codeAmount != null" >
        code_amount = #{record.codeAmount,jdbcType=DECIMAL},
      </if>
      <if test="record.rebateStatus != null" >
        rebate_status = #{record.rebateStatus,jdbcType=VARCHAR},
      </if>
      <if test="record.rebateType != null" >
        rebate_type = #{record.rebateType,jdbcType=VARCHAR},
      </if>
      <if test="record.rebateAmount != null" >
        rebate_amount = #{record.rebateAmount,jdbcType=DECIMAL},
      </if>
      <if test="record.sendTime != null" >
        send_time = #{record.sendTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.createTime != null" >
        create_time = #{record.createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.userType != null" >
        user_type = #{record.userType,jdbcType=VARCHAR},
      </if>
    </set>
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map" >
    update user_rebate_record
    set id = #{record.id,jdbcType=BIGINT},
      operator_id = #{record.operatorId,jdbcType=BIGINT},
      seller_user_id = #{record.sellerUserId,jdbcType=BIGINT},
      user_id = #{record.userId,jdbcType=BIGINT},
      order_id = #{record.orderId,jdbcType=BIGINT},
      rebate_code = #{record.rebateCode,jdbcType=VARCHAR},
      order_user_id = #{record.orderUserId,jdbcType=BIGINT},
      code_amount = #{record.codeAmount,jdbcType=DECIMAL},
      rebate_status = #{record.rebateStatus,jdbcType=VARCHAR},
      rebate_type = #{record.rebateType,jdbcType=VARCHAR},
      rebate_amount = #{record.rebateAmount,jdbcType=DECIMAL},
      send_time = #{record.sendTime,jdbcType=TIMESTAMP},
      create_time = #{record.createTime,jdbcType=TIMESTAMP},
      user_type = #{record.userType,jdbcType=VARCHAR}
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.sinco.carnation.user.model.RebateRecord" >
    update user_rebate_record
    <set >
      <if test="operatorId != null" >
        operator_id = #{operatorId,jdbcType=BIGINT},
      </if>
      <if test="sellerUserId != null" >
        seller_user_id = #{sellerUserId,jdbcType=BIGINT},
      </if>
      <if test="userId != null" >
        user_id = #{userId,jdbcType=BIGINT},
      </if>
      <if test="orderId != null" >
        order_id = #{orderId,jdbcType=BIGINT},
      </if>
      <if test="rebateCode != null" >
        rebate_code = #{rebateCode,jdbcType=VARCHAR},
      </if>
      <if test="orderUserId != null" >
        order_user_id = #{orderUserId,jdbcType=BIGINT},
      </if>
      <if test="codeAmount != null" >
        code_amount = #{codeAmount,jdbcType=DECIMAL},
      </if>
      <if test="rebateStatus != null" >
        rebate_status = #{rebateStatus,jdbcType=VARCHAR},
      </if>
      <if test="rebateType != null" >
        rebate_type = #{rebateType,jdbcType=VARCHAR},
      </if>
      <if test="rebateAmount != null" >
        rebate_amount = #{rebateAmount,jdbcType=DECIMAL},
      </if>
      <if test="sendTime != null" >
        send_time = #{sendTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="userType != null" >
        user_type = #{userType,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.sinco.carnation.user.model.RebateRecord" >
    update user_rebate_record
    set operator_id = #{operatorId,jdbcType=BIGINT},
      seller_user_id = #{sellerUserId,jdbcType=BIGINT},
      user_id = #{userId,jdbcType=BIGINT},
      order_id = #{orderId,jdbcType=BIGINT},
      rebate_code = #{rebateCode,jdbcType=VARCHAR},
      order_user_id = #{orderUserId,jdbcType=BIGINT},
      code_amount = #{codeAmount,jdbcType=DECIMAL},
      rebate_status = #{rebateStatus,jdbcType=VARCHAR},
      rebate_type = #{rebateType,jdbcType=VARCHAR},
      rebate_amount = #{rebateAmount,jdbcType=DECIMAL},
      send_time = #{sendTime,jdbcType=TIMESTAMP},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      user_type = #{userType,jdbcType=VARCHAR}
      where id = #{id,jdbcType=BIGINT}
  </update>
</mapper>